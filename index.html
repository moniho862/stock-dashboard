<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>å­˜è‚¡å„€è¡¨æ¿</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg1:#070A12;
      --bg2:#0B1430;
      --card:rgba(20,26,45,.72);
      --card2:rgba(20,26,45,.55);
      --stroke:rgba(255,255,255,.10);
      --stroke2:rgba(255,255,255,.08);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.62);
      --accent:#C9A24B;
      --good:#32D583;
      --bad:#F97066;

      /* æ‰‹æ©Ÿå­—é«”æ”¾å¤§ */
      --fs-title:18px;
      --fs-body:14px;
      --fs-small:12px;
      --fs-num:28px;
    }

    @media (min-width: 900px){
      :root{
        --fs-title:18px;
        --fs-body:14px;
        --fs-small:12px;
        --fs-num:30px;
      }
    }

    html,body{ height:100%; }
    body{
      margin:0;
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", sans-serif;
      background:
        radial-gradient(1200px 800px at 30% 20%, rgba(201,162,75,.25), transparent 60%),
        radial-gradient(900px 700px at 70% 30%, rgba(80,120,255,.18), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      overflow-x:hidden;
    }

    /* é›»è…¦ï¼šåƒä½ æµæ°´å¸³é‚£æ¨£çª„å¯¬ç½®ä¸­ï¼›æ‰‹æ©Ÿï¼šæ»¿ç‰ˆ */
    .shell{
      width:100%;
      display:flex;
      justify-content:center;
      padding: 14px 12px calc(110px + env(safe-area-inset-bottom));
      box-sizing:border-box;
    }
    .app{
      width: 100%;
      max-width: 520px;   /* é›»è…¦å›ºå®šçª„å¯¬ */
    }
    @media (max-width: 600px){
      .shell{
        padding: 12px 10px calc(110px + env(safe-area-inset-bottom));
      }
      .app{
        max-width: 100%;  /* æ‰‹æ©Ÿæ»¿ç‰ˆ */
      }
      :root{
        --fs-body:15px;
        --fs-small:13px;
        --fs-num:30px;
      }
    }

    .topbar{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      padding:14px 14px;
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      backdrop-filter: blur(10px);
      border-radius: 18px;
      box-shadow: 0 14px 60px rgba(0,0,0,.35);
    }
    .brand h1{
      margin:0 0 6px 0;
      font-size: 20px;
      letter-spacing:.5px;
    }
    .meta{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      font-size: var(--fs-small);
      color: var(--muted);
      align-items:center;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border:1px solid var(--stroke2);
      border-radius: 999px;
      background: rgba(0,0,0,.15);
    }
    .dot{
      width:8px;height:8px;border-radius:50%;
      background: var(--good);
      box-shadow: 0 0 0 4px rgba(50,213,131,.15);
    }

    .btn{
      border:1px solid rgba(201,162,75,.45);
      color:var(--text);
      background: rgba(201,162,75,.16);
      padding:10px 12px;
      border-radius: 999px;
      cursor:pointer;
      font-size: var(--fs-body);
      font-weight: 700;
      white-space:nowrap;
    }
    .btn:active{ transform: translateY(1px); }

    .section{
      margin-top: 12px;
      border:1px solid var(--stroke);
      background: rgba(20,26,45,.40);
      border-radius: 18px;
      overflow:hidden;
      box-shadow: 0 18px 70px rgba(0,0,0,.30);
    }
    .section .hd{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding: 12px 14px;
      border-bottom: 1px solid var(--stroke2);
      background: rgba(0,0,0,.12);
    }
    .section .hd .title{
      font-size: var(--fs-title);
      font-weight: 800;
      letter-spacing:.3px;
    }
    .section .bd{
      padding: 12px 14px;
    }

    .cards{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .card{
      border:1px solid var(--stroke2);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border-radius: 16px;
      padding: 12px 12px;
    }
    .k{
      font-size: var(--fs-small);
      color: var(--muted);
      margin-bottom: 6px;
    }
    .v{
      font-size: var(--fs-num);
      font-weight: 900;
      letter-spacing:.2px;
      line-height:1.1;
    }
    .sub{
      margin-top: 6px;
      font-size: var(--fs-small);
      color: var(--muted);
    }
    .good{ color: var(--good); }
    .bad{ color: var(--bad); }

    .chartWrap{
      width:100%;
      display:flex;
      justify-content:center;
      padding: 6px 0 0 0;
    }
    canvas{ max-width: 100% !important; }

    .tableWrap{
      width:100%;
      overflow-x:auto;              /* âœ… å·¦å³æ‹–æ›³ */
      -webkit-overflow-scrolling: touch;
      border:1px solid var(--stroke2);
      border-radius: 14px;
      background: rgba(0,0,0,.12);
    }
    table{
      border-collapse: collapse;
      width: 760px;
      min-width: 760px;
      font-size: var(--fs-body);
    }
    th,td{
      padding:10px 10px;
      border-bottom:1px solid rgba(255,255,255,.06);
      white-space:nowrap;
      text-align:right;
    }
    th:first-child, td:first-child{ text-align:left; }
    th{
      font-size: var(--fs-small);
      color: var(--muted);
      background: rgba(0,0,0,.10);
      position: sticky;
      top: 0;
    }

    .formGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    label{
      font-size: var(--fs-small);
      color: var(--muted);
    }
    input,select,textarea{
      border:1px solid var(--stroke2);
      background: rgba(0,0,0,.18);
      color: var(--text);
      padding: 12px 12px;
      border-radius: 12px;
      font-size: var(--fs-body);
      outline:none;
    }
    textarea{ grid-column: 1 / -1; resize: none; }
    .formActions{
      margin-top: 10px;
      display:flex;
      gap:10px;
      justify-content:flex-start;
      align-items:center;
      flex-wrap:wrap;
    }
    .hint{
      font-size: var(--fs-small);
      color: var(--muted);
      line-height:1.4;
    }

    /* Bottom tab bar (å›ºå®š) */
    .tabbar{
      position: fixed;
      left:0; right:0; bottom:0;
      padding: 10px 12px calc(10px + env(safe-area-inset-bottom));
      box-sizing:border-box;
      z-index: 999;
      display:flex;
      justify-content:center;
      pointer-events:none;
    }
    .tabs{
      width: 100%;
      max-width: 520px;
      pointer-events:auto;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(8,10,16,.62);
      backdrop-filter: blur(14px);
      border-radius: 18px;
      padding: 10px;
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      box-shadow: 0 12px 60px rgba(0,0,0,.50);
    }
    .tab{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      border-radius: 14px;
      padding: 10px 8px;
      color: var(--text);
      text-align:center;
      cursor:pointer;
      font-weight:800;
      font-size: 13px;
      display:flex;
      flex-direction:column;
      gap:6px;
      align-items:center;
      justify-content:center;
      min-height: 54px;
    }
    .tab .ic{ font-size: 18px; opacity:.95; }
    .tab.active{
      border-color: rgba(201,162,75,.55);
      background: rgba(201,162,75,.20);
      box-shadow: 0 10px 40px rgba(201,162,75,.12);
    }

    .toast{
      position: fixed;
      left:50%;
      transform: translateX(-50%);
      bottom: 96px;
      z-index: 999;
      background: rgba(0,0,0,.70);
      border:1px solid rgba(255,255,255,.14);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      font-size: var(--fs-body);
      display:none;
      max-width: min(520px, calc(100% - 24px));
    }
  </style>
</head>

<body>
  <div class="shell">
    <div class="app" id="app">
      <div class="topbar">
        <div class="brand">
          <h1>å­˜è‚¡å„€è¡¨æ¿</h1>
          <div class="meta">
            <span class="pill"><span class="dot"></span><span id="priceUpdatedAt">æ”¶ç›¤åƒ¹æ›´æ–°æ™‚é–“ï¼šâ€”</span></span>
            <span class="pill" id="scopeLabel">ç¸½è¨ˆ</span>
          </div>
        </div>
        <button class="btn" id="btnRefresh">æ›´æ–°æœ€æ–°è‚¡åƒ¹</button>
      </div>

      <div class="section" style="margin-top:12px;">
        <div class="hd">
          <div class="title" id="summaryTitle">ç¸½è¨ˆ</div>
          <div class="hint" id="summaryHint">å¸‚å€¼èˆ‡æç›Šä»¥æœ€æ–°æ”¶ç›¤åƒ¹ä¼°ç®—</div>
        </div>
        <div class="bd">
          <div class="cards">
            <div class="card">
              <div class="k">åº«å­˜ç¸½å¸‚å€¼ï¼ˆNTDï¼‰</div>
              <div class="v" id="mv">â€”</div>
              <div class="sub" id="mvSub">â€”</div>
            </div>
            <div class="card">
              <div class="k">æç›Šè©¦ç®—</div>
              <div class="v" id="pnl">â€”</div>
              <div class="sub">å¸‚å€¼ - æˆæœ¬</div>
            </div>
            <div class="card">
              <div class="k">å ±é…¬ç‡</div>
              <div class="v" id="rr">â€”</div>
              <div class="sub">æç›Š Ã· æˆæœ¬</div>
            </div>
            <div class="card">
              <div class="k">ç¸½ä»˜å‡ºæˆæœ¬ï¼ˆå«æ‰‹çºŒè²»ï¼‰</div>
              <div class="v" id="cost">â€”</div>
              <div class="sub">è²·å…¥é‡‘é¡ + æ‰‹çºŒè²» + ç¨…</div>
            </div>
          </div>
        </div>
      </div>

      <div class="section">
        <div class="hd">
          <div class="title">æŒè‚¡é…ç½®ï¼ˆä¾å¸‚å€¼ï¼‰</div>
          <div class="hint" id="maxHold">æœ€å¤§æŒè‚¡ï¼šâ€”</div>
        </div>
        <div class="bd">
          <div class="chartWrap">
            <canvas id="donut" width="340" height="240"></canvas>
          </div>
        </div>
      </div>

      <div class="section">
        <div class="hd">
          <div class="title">æŒè‚¡æ˜ç´°ï¼ˆå·²ç¢ºèªï¼‰</div>
          <div class="hint">è¡¨æ ¼å¯å·¦å³æ‹–æ›³</div>
        </div>
        <div class="bd">
          <div class="tableWrap">
            <table id="holdTable">
              <thead>
                <tr>
                  <th>è‚¡ç¥¨ä»£è™Ÿ</th>
                  <th>åº«å­˜è‚¡æ•¸</th>
                  <th>å‡åƒ¹(å°å¹£)</th>
                  <th>æ”¶ç›¤åƒ¹(å°å¹£)</th>
                  <th>å¸‚å€¼</th>
                  <th>æç›Š</th>
                  <th>å ±é…¬ç‡</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- æ–°å¢äº¤æ˜“ï¼šåªæœ‰ å°è‚¡/ç¾è‚¡/ibrAin é¡¯ç¤ºï¼›ç¸½è¨ˆä¸é¡¯ç¤º -->
      <div class="section" id="tradeSection" style="display:none;">
        <div class="hd">
          <div class="title" id="tradeTitle">æ–°å¢äº¤æ˜“</div>
          <div class="hint" id="tradeHint">â€”</div>
        </div>
        <div class="bd">
          <div class="formGrid" id="tradeForm"></div>

          <div class="formActions">
            <button class="btn" id="btnAddTx">æ–°å¢</button>
            <div class="hint" id="txHint"></div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Bottom Tab -->
  <div class="tabbar">
    <div class="tabs">
      <div class="tab active" data-scope="ALL"><div class="ic">Î£</div><div>ç¸½è¨ˆ</div></div>
      <div class="tab" data-scope="TW"><div class="ic">ğŸ›ï¸</div><div>å°è‚¡</div></div>
      <div class="tab" data-scope="US"><div class="ic">ğŸŒ</div><div>ç¾è‚¡</div></div>
      <div class="tab" data-scope="IB"><div class="ic">ğŸ§ </div><div>ibrAin</div></div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
  /***********************
   * ä½ åªè¦æ”¹é€™ä¸€è¡Œï¼š
   ***********************/
  const API_BASE = "https://script.google.com/macros/s/AKfycbwvXQ35Yz7ZGqUgNGh6xA6fACilA94cx0aLV8QNJT2wnb8f-7nrJlqUo4eWz9gecjuX/exec";
</script>

<script>
  /***********************
   * JSONP helperï¼ˆé¿é–‹ CORSï¼‰
   ***********************/
  function jsonp(url){
    return new Promise((resolve, reject) => {
      const cb = "cb_" + Math.random().toString(36).slice(2);
      const s = document.createElement("script");
      const sep = url.includes("?") ? "&" : "?";
      const timeout = setTimeout(() => {
        cleanup();
        reject(new Error("JSONP timeout"));
      }, 15000);

      function cleanup(){
        clearTimeout(timeout);
        if (s && s.parentNode) s.parentNode.removeChild(s);
        try{ delete window[cb]; }catch(e){ window[cb] = undefined; }
      }

      window[cb] = (data) => {
        cleanup();
        resolve(data);
      };

      s.src = url + sep + "callback=" + cb + "&_=" + Date.now();
      s.onerror = () => {
        cleanup();
        reject(new Error("JSONP load error"));
      };
      document.body.appendChild(s);
    });
  }

  function apiGet(action, params={}){
    const qs = new URLSearchParams({ action, ...params }).toString();
    return jsonp(`${API_BASE}?${qs}`);
  }
</script>

<script>
  /***********************
   * UIï¼ˆä¿®æ­£ï¼šçœŸæ­£ä¾é ç±¤åˆ‡ TW / US / IBï¼‰
   ***********************/
  const state = {
    scope: "ALL",
    donut: null,
    lastDashboard: null
  };

  const $ = (id) => document.getElementById(id);

  function toast(msg){
    const t = $("toast");
    t.textContent = msg;
    t.style.display = "block";
    clearTimeout(window.__toastTimer);
    window.__toastTimer = setTimeout(() => t.style.display = "none", 2600);
  }

  function money(n, digits=0){
    const x = Number(n);
    if (!isFinite(x)) return "â€”";
    return x.toLocaleString("zh-Hant-TW", { minimumFractionDigits: digits, maximumFractionDigits: digits });
  }
  function pct(n){
    const x = Number(n);
    if (!isFinite(x)) return "â€”";
    return (x*100).toFixed(2) + "%";
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }

  /* ====== å¸‚å ´åˆ†é¡ ====== */
  function classifySymbol(sym){
    const s = String(sym || "").trim().toUpperCase();
    if (!s) return "TW";
    if (s === "IBRAIN") return "IB";
    if (/^\d+$/.test(s)) return "TW";
    if (/^[A-Z]/.test(s)) return "US";
    return "TW";
  }

  /* ====== ä¾ scope ç¯©é¸ï¼ˆå‰ç«¯ä¿®æ­£ï¼Œä¸ä¾è³´å¾Œç«¯ï¼‰ ====== */
  function filterByScope(dashboard, scope){
    if (!dashboard) return dashboard;
    if (scope === "ALL") return dashboard;

    const keep = (sym) => classifySymbol(sym) === scope;

    // æ·±æ‹·è²ï¼Œé¿å…æ±¡æŸ“åŸå§‹è³‡æ–™
    const out = JSON.parse(JSON.stringify(dashboard));

    out.holdings = (out.holdings || []).filter(h => keep(h.symbol));
    out.allocation = (out.allocation || []).filter(a => keep(a.symbol));

    // é‡æ–°ç®— summaryï¼ˆåªç®—è©²å¸‚å ´ï¼‰
    const totalMV = out.holdings.reduce((s, h) => s + (Number(h.marketValue) || 0), 0);
    const totalCost = out.holdings.reduce((s, h) => s + (Number(h.cost) || 0), 0);
    const totalPnl = totalMV - totalCost;
    const totalRr = totalCost > 0 ? totalPnl / totalCost : 0;

    out.summary = {
      totalMarketValue: totalMV,
      totalCost: totalCost,
      totalPnl: totalPnl,
      totalRr: totalRr
    };

    return out;
  }

  function setScopeLabel(scope){
    const map = { ALL:"ç¸½è¨ˆ", TW:"å°è‚¡", US:"ç¾è‚¡", IB:"ibrAin" };
    $("scopeLabel").textContent = map[scope] || scope;
    $("summaryTitle").textContent = map[scope] || scope;

    // æ–°å¢äº¤æ˜“å€å¡Šé¡¯ç¤ºè¦å‰‡
    if (scope === "ALL"){
      $("tradeSection").style.display = "none";
    } else {
      $("tradeSection").style.display = "block";
      $("tradeTitle").textContent = `æ–°å¢äº¤æ˜“ï¼ˆ${map[scope]}ï¼‰`;
    }
  }

  function renderSummary(res){
    $("priceUpdatedAt").textContent = "æ”¶ç›¤åƒ¹æ›´æ–°æ™‚é–“ï¼š" + (res.priceUpdatedAt || "â€”");
    const s = res.summary || {};
    $("mv").textContent = money(s.totalMarketValue, 2);
    $("cost").textContent = money(s.totalCost, 0);

    const pnl = Number(s.totalPnl || 0);
    $("pnl").textContent = money(pnl, 2);
    $("pnl").className = "v " + (pnl >= 0 ? "good" : "bad");

    const rr = Number(s.totalRr || 0);
    $("rr").textContent = pct(rr);
    $("rr").className = "v " + (rr >= 0 ? "good" : "bad");

    // å¸‚å€¼å‰¯æ¨™
    if (state.scope === "TW") $("mvSub").textContent = "å°è‚¡ï¼šè‚¡æ•¸ Ã— æ”¶ç›¤åƒ¹(å°å¹£)";
    else if (state.scope === "US") $("mvSub").textContent = "ç¾è‚¡ï¼šè‚¡æ•¸ Ã— æœ€æ–°USDåƒ¹ Ã— æœ€æ–°åŒ¯ç‡";
    else if (state.scope === "IB") $("mvSub").textContent = "ibrAinï¼šè‚¡æ•¸ Ã— æœ€æ–°USDåƒ¹ Ã— æœ€æ–°åŒ¯ç‡";
    else $("mvSub").textContent = "å…¨éƒ¨ï¼šåˆä½µè¨ˆç®—";
  }

  function renderTable(res){
    const tbody = $("holdTable").querySelector("tbody");
    tbody.innerHTML = "";
    const rows = res.holdings || [];
    rows.forEach(h => {
      const tr = document.createElement("tr");
      const rr = Number(h.rr || 0);
      const pnl = Number(h.pnl || 0);
      tr.innerHTML = `
        <td>${escapeHtml(h.symbol || "")}</td>
        <td>${money(h.qty, 6)}</td>
        <td>${money(h.avgCost, 2)}</td>
        <td>${h.closeTwd === "" ? "â€”" : money(h.closeTwd, 2)}</td>
        <td>${money(h.marketValue, 2)}</td>
        <td class="${pnl>=0?"good":"bad"}">${money(pnl, 2)}</td>
        <td class="${rr>=0?"good":"bad"}">${pct(rr)}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function renderDonut(res){
    const alloc = res.allocation || [];
    const labels = alloc.map(x => x.symbol);
    const values = alloc.map(x => x.value);

    // æœ€å¤§æŒè‚¡
    if (alloc.length){
      const top = alloc[0];
      $("maxHold").textContent = `æœ€å¤§æŒè‚¡ï¼š${top.symbol} ${(top.pct*100).toFixed(1)}%`;
    } else {
      $("maxHold").textContent = "æœ€å¤§æŒè‚¡ï¼šâ€”";
    }

    const ctx = document.getElementById("donut").getContext("2d");
    if (state.donut) state.donut.destroy();

    // æ²’è³‡æ–™ä¹Ÿè¦é¡¯ç¤ºä¸€å€‹ç©ºåœ–ï¼Œä¸è¦æ•´å€‹æ¶ˆå¤±
    const safeLabels = labels.length ? labels : ["â€”"];
    const safeValues = values.length ? values : [1];

    state.donut = new Chart(ctx, {
      type: "doughnut",
      data: {
        labels: safeLabels,
        datasets: [{
          data: safeValues,
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        cutout: "70%",
        plugins: {
          legend: {
            display: true,
            labels: { color: "rgba(255,255,255,.75)" }
          },
          tooltip: {
            callbacks: {
              label: (c) => {
                const v = c.parsed || 0;
                if (!values.length) return "â€”";
                return `${c.label}: ${money(v, 0)} NTD`;
              }
            }
          }
        }
      }
    });
  }

  async function loadDashboard(){
    try{
      setScopeLabel(state.scope);

      // âš ï¸ å¾Œç«¯ getDashboard æœªæ”¯æ´ scopeï¼Œæ‰€ä»¥é€™è£¡æ‹¿ã€ŒåŸå§‹ç¸½è³‡æ–™ã€
      const raw = await apiGet("getDashboard");
      if (!raw.ok) throw new Error(raw.error || "è®€å–å¤±æ•—");
      state.lastDashboard = raw;

      // âœ… å‰ç«¯ä¾ scope çœŸçš„åˆ‡å‡º TW/US/IB
      const res = filterByScope(raw, state.scope);

      renderSummary(res);
      renderDonut(res);
      renderTable(res);

      renderTradeForm();
    }catch(e){
      toast("è®€å–å¤±æ•—ï¼š" + e.message);
    }
  }

  async function refreshPrices(){
    try{
      toast("æ›´æ–°è‚¡åƒ¹ä¸­â€¦");
      const res = await apiGet("refreshPrices");
      if (!res.ok) throw new Error(res.error || "æ›´æ–°å¤±æ•—");
      toast("å·²æ›´æ–°");
      await loadDashboard();
    }catch(e){
      toast("æ›´æ–°å¤±æ•—ï¼š" + e.message);
    }
  }

  /***********************
   * ä½ åŸæœ¬çš„æ–°å¢äº¤æ˜“è¡¨å–®ï¼ˆä¿ç•™ä¸å‹•ï¼‰
   ***********************/
  function renderTradeForm(){
    const scope = state.scope;
    const grid = $("tradeForm");
    grid.innerHTML = "";
    $("txHint").textContent = "";

    if (scope === "ALL"){
      $("tradeSection").style.display = "none";
      return;
    }

    $("tradeSection").style.display = "block";

    function addField(id, label, type="text", placeholder="", opts=null){
      const wrap = document.createElement("div");
      wrap.className = "field";
      const lab = document.createElement("label");
      lab.textContent = label;
      wrap.appendChild(lab);

      let el;
      if (type === "select"){
        el = document.createElement("select");
        (opts||[]).forEach(o=>{
          const op = document.createElement("option");
          op.value = o.value; op.textContent = o.text;
          el.appendChild(op);
        });
      } else if (type === "textarea"){
        el = document.createElement("textarea");
        el.rows = 2;
      } else {
        el = document.createElement("input");
        el.type = type;
      }
      el.id = id;
      el.placeholder = placeholder;
      wrap.appendChild(el);
      grid.appendChild(wrap);
      return el;
    }

    const today = new Date();
    const y = today.getFullYear();
    const m = String(today.getMonth()+1).padStart(2,"0");
    const d = String(today.getDate()).padStart(2,"0");
    const todayStr = `${y}-${m}-${d}`;

    if (scope === "TW"){
      $("tradeHint").textContent = "å°è‚¡ï¼šé‡‘é¡/è‚¡æ•¸/å–®åƒ¹ä»»å…©å€‹å³å¯æ¨ç®—å¦ä¸€å€‹ã€‚è‚¡ç¥¨ä»£è™Ÿå¯ä¿ç•™å‰å° 0ã€‚";
      addField("txDate","äº¤æ˜“æ—¥æœŸ","date","",null).value = todayStr;
      addField("txSymbol","è‚¡ç¥¨ä»£è™Ÿ","text","ä¾‹å¦‚ 0056");
      addField("txAmount","äº¤æ˜“é‡‘é¡ï¼ˆå°å¹£ï¼‰","number","ä¾‹å¦‚ 1000");
      addField("txQty","è‚¡æ•¸ï¼ˆå¯ç©ºï¼‰","number","ä¾‹å¦‚ 100");
      addField("txPrice","æˆäº¤å–®åƒ¹ï¼ˆå¯ç©ºï¼‰","number","ä¾‹å¦‚ 37.13");
      addField("txFee","æ‰‹çºŒè²»ï¼ˆé¸å¡«ï¼‰","number","ä¾‹å¦‚ 20");
      addField("txTax","äº¤æ˜“ç¨…ï¼ˆé¸å¡«ï¼‰","number","ä¾‹å¦‚ 0");
      addField("txSource","ä¾†æºé¡å‹","select","",[
        {value:"æ‰‹å‹•è²·å…¥",text:"æ‰‹å‹•è²·å…¥"},
        {value:"å®šæœŸå®šé¡",text:"å®šæœŸå®šé¡"}
      ]);
      addField("txBroker","è­‰åˆ¸å•†ï¼ˆé¸å¡«ï¼‰","text","ä¾‹å¦‚ æ–°å…‰");
      addField("txNote","å‚™è¨»ï¼ˆé¸å¡«ï¼‰","textarea","ä¾‹å¦‚ï¼šå®šæœŸå®šé¡ 2025-04");
      $("txHint").textContent = "æ–°å¢äº¤æ˜“ï¼šéœ€å¾Œç«¯æ”¯æ´ addTransactionGet æ‰èƒ½å¾ GitHub å¯«å…¥è©¦ç®—è¡¨ã€‚";
    }

    if (scope === "US"){
      $("tradeHint").textContent = "ç¾è‚¡ï¼šæŠ•å…¥å°å¹£å›ºå®š 1000ï¼Œä¾åŒ¯ç‡èˆ‡è‚¡åƒ¹ä¸åŒè²·åˆ°ä¸åŒè‚¡æ•¸ã€‚";
      addField("txDate","äº¤æ˜“æ—¥æœŸ","date","",null).value = todayStr;
      addField("txSymbol","è‚¡ç¥¨ä»£è™Ÿ","text","ä¾‹å¦‚ VOO");
      addField("txAmount","æŠ•å…¥é‡‘é¡ï¼ˆå°å¹£ï¼‰","number","ä¾‹å¦‚ 1000");
      addField("txFx","åŒ¯ç‡ï¼ˆå°å¹£/ç¾é‡‘ï¼‰","number","ä¾‹å¦‚ 33.185");
      addField("txPrice","ç¾é‡‘è‚¡åƒ¹ï¼ˆUSDï¼‰","number","ä¾‹å¦‚ 449.59");
      addField("txQty","è‚¡æ•¸ï¼ˆå¯å¡«ï¼›ä¸å¡«å‰‡ä¾å…¬å¼æ¨ç®—ï¼‰","number","ä¾‹å¦‚ 0.06702");
      addField("txFee","æ‰‹çºŒè²»ï¼ˆå°å¹£ï¼›é¸å¡«ï¼‰","number","ä¾‹å¦‚ 0");
      addField("txTax","äº¤æ˜“ç¨…ï¼ˆå°å¹£ï¼›é¸å¡«ï¼‰","number","ä¾‹å¦‚ 0");
      addField("txSource","ä¾†æºé¡å‹","select","",[
        {value:"æ‰‹å‹•è²·å…¥",text:"æ‰‹å‹•è²·å…¥"},
        {value:"å®šæœŸå®šé¡",text:"å®šæœŸå®šé¡"}
      ]);
      addField("txBroker","åˆ¸å•†ï¼ˆé¸å¡«ï¼‰","text","ä¾‹å¦‚ æ°¸è±");
      addField("txNote","å‚™è¨»ï¼ˆé¸å¡«ï¼‰","textarea","ä¾‹å¦‚ï¼šå®šæœŸå®šé¡ 2025-04");
      $("txHint").textContent = "æ–°å¢äº¤æ˜“ï¼šéœ€å¾Œç«¯æ”¯æ´ addTransactionGet æ‰èƒ½å¾ GitHub å¯«å…¥è©¦ç®—è¡¨ã€‚";
    }

    if (scope === "IB"){
      $("tradeHint").textContent = "ibrAinï¼šåŒç¾è‚¡é‚è¼¯ã€‚";
      addField("txDate","äº¤æ˜“æ—¥æœŸ","date","",null).value = todayStr;
      const sym = addField("txSymbol","è‚¡ç¥¨ä»£è™Ÿ","text","ä¾‹å¦‚ IBRAIN");
      sym.value = "IBRAIN";
      addField("txAmount","æŠ•å…¥é‡‘é¡ï¼ˆå°å¹£ï¼‰","number","ä¾‹å¦‚ 1000");
      addField("txFx","åŒ¯ç‡ï¼ˆå°å¹£/ç¾é‡‘ï¼‰","number","ä¾‹å¦‚ 33.185");
      addField("txPrice","ç¾é‡‘è‚¡åƒ¹ï¼ˆUSDï¼‰","number","ä¾‹å¦‚ 1.23");
      addField("txQty","è‚¡æ•¸ï¼ˆå¯å¡«ï¼›ä¸å¡«å‰‡ä¾å…¬å¼æ¨ç®—ï¼‰","number","ä¾‹å¦‚ 10");
      addField("txFee","æ‰‹çºŒè²»ï¼ˆå°å¹£ï¼›é¸å¡«ï¼‰","number","ä¾‹å¦‚ 0");
      addField("txTax","äº¤æ˜“ç¨…ï¼ˆå°å¹£ï¼›é¸å¡«ï¼‰","number","ä¾‹å¦‚ 0");
      addField("txSource","ä¾†æºé¡å‹","select","",[
        {value:"æ‰‹å‹•è²·å…¥",text:"æ‰‹å‹•è²·å…¥"},
        {value:"å®šæœŸå®šé¡",text:"å®šæœŸå®šé¡"}
      ]);
      addField("txBroker","åˆ¸å•†ï¼ˆé¸å¡«ï¼‰","text","ä¾‹å¦‚ â€”");
      addField("txNote","å‚™è¨»ï¼ˆé¸å¡«ï¼‰","textarea","ä¾‹å¦‚ï¼šå®šæœŸå®šé¡ 2025-04");
      $("txHint").textContent = "æ–°å¢äº¤æ˜“ï¼šéœ€å¾Œç«¯æ”¯æ´ addTransactionGet æ‰èƒ½å¾ GitHub å¯«å…¥è©¦ç®—è¡¨ã€‚";
    }
  }

  function bindTabs(){
    document.querySelectorAll(".tab").forEach(tab=>{
      tab.addEventListener("click", async ()=>{
        document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
        tab.classList.add("active");
        state.scope = tab.dataset.scope;
        await loadDashboard();
      });
    });
  }

  function bindActions(){
    $("btnRefresh").addEventListener("click", refreshPrices);
    $("btnAddTx").addEventListener("click", ()=>{
      toast("æ–°å¢äº¤æ˜“ï¼šè«‹å…ˆåœ¨å¾Œç«¯åŠ å…¥ addTransactionGetï¼Œæˆ‘å¯ä»¥çµ¦ä½  Code.gs å®Œæ•´ç‰ˆã€‚");
    });
  }

  async function boot(){
    bindTabs();
    bindActions();
    await loadDashboard();
  }

  boot();
</script>

</body>
</html>
